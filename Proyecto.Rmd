---
title: "Proyecto"
author: ''
date: '2022-06-14'
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.pos = 'hbpt', out.extra = '', message = FALSE, warning = FALSE)
```

```{r}
library(ggmosaic)
library(tidyverse)
library(here)
library(readxl)
library(xtable)
library(maptools)
library(rgdal)
library(patchwork)
library(plotly)

datos <- read_xlsx(here("Datos","Datos_base_ganadera.xlsx"))

```


## Introducción

Este proyecto nace como un instrumento para poder aplicar los contenidos aprendidos durante el semestre en un problema real. Se tendrá que demostrar los conocimentos adquiridos al realizar un análisis exploratorio sobre datos de interés nacional, poniendo especial énfasis en la correcta visualización de los resultados obtenidos, realizando una correcta interpretación de la misma. 

En el caso de este grupo en cuestión, se analizarán datos de una encuesta ganadera, que fueron elegidos para llevar a cabo estos objetivos, relacionando las características de la persona fisíca y su territorio con su productividad y tecnología, entre otras variables. Se utilizará exclusivamente el lenguaje de programación R, y sus respectivas expansiones, como RMarkdown, Shiny y RStudio.

\textcolor{violet}{Debe quedar más claro que son los datos,tienen un reporte sobre la encuensta que les puede ayudar para escribir cuál es el objetivo e dicha encuesta y referenciarla, veo que escriben más abajo esto pero en la introduccion deben porner algo más que es una encuesta gropecuaria. Los paquetes y R se deben citar. 
Les puse el doc que compile a pdf, echo=FALSE para que no salga el código en el doc por defecto y les arreglé la tabla}

## Datos

Ésta encuesta fue realizada por el Ministerio de Ganadería, Agricultura y Pesca del Uruguay, y las  organizaciones que participaron fueron el Banco Central del Uruguay (BCU), Instituto Nacional de
Investigación Agropecuaria (INIA), Agencia de Evaluación de la OPP (AGEV), Agencia Nacional
de Investigación e Innovación (ANII), Secretariado Uruguayo de la Lana (SUL), y la Unidad de
Gestión de Proyectos (UGP) del MGAP.

El principal objetivo de la encuesta es es lograr una estimación del consumo intermedio de las actividades agropecuarias, realizando una encuesta económica del sector ganadero ovino y bovino uruguayo para relevar
información sobre los tipos y la intensidad de utilización de insumos según diferentes tecnologías, la
disposición innovadora de los agentes, el trabajo empleado y los gastos generales incurridos por las
unidades de producción.

Trata de un muestreo cuya base muestral fue el censo general agropecuario del 2011 que tenía 25.566 explotaciones ganaderas, todas las variables son de tipo **double** ya que eran preguntas multiple opción (en su mayoría) con una recodificación numérica. Luego se realizó un muestreo por estrato de tamaño y por un criterio geográfico. El tamaño de la muestra resultó ser de 1.506 casos (explotacion con actividad principal a la ganaderia vacuna o ovina) algunos fueron descartados (porque ya no eran ganaderos o por otros aspectos) por lo que la muestra final es de 1.426 .

En este trabajo se propone una descripción de los resultados de la encuesta sin expandir a través de ponderadores por lo que los resultados a los que arribemos solo serán validos para estos casos y no serán conclusiones que se puedan extender al conjunto de los productores ganaderos.

```{r, results='asis'}
options(xtable.comment = FALSE)

datos_1 <- data.frame(Variable = c("a11","a9","a12","aiv_nueva",
                                   "a16_i","dpto","b3_i","b3_7","est"),
                      Descripcion = c("Edad","Condición Jurídica","Nivel de Educación","Cantidad innovaciones realizadas en 8 posibles ramas distintas","Tipo de energía utilizada","Departamento donde se ubica la propiedad","Tenencia de Tierras","Total del territorio en ha","Unidades ganaderas en el territorio (1-8)"))


datos_1 %>% xtable(caption="Descripción de las Variables") %>% print(include.rownames = FALSE)
```

## Analisis

 Para realizar la exploración, nos planteamos algunas preguntas para orientar el análisis. En primer lugar, decidimos investigar la condicion Jurídica de los propietarios encuestados. Observamos como en su mayoria son Personas fisicas, 
 
```{r, fig.cap= "Condicion Juridica de los encuestados"}
datos %>% 
  group_by(a9) %>% 
  ggplot(aes(x=fct_infreq(factor(a9)),fill=factor(a9)))+
  geom_bar()+
  labs(y="Cantidad")+
  scale_x_discrete(name="Condición jurídica",labels = c(
                                                       '1' = 'Persona física',
                                                       '2' = 'Sociedad sin contrato',
                                                       '3' = 'Sociedad con \n contrato legal',
                                                       '4' = 'Otra')) + theme_bw()+
  theme(legend.position='none') 
```

\textcolor{violet}{Deben incluir referencias cruzadas y en la figura debe aparecer el nombre del gráfico y la variable o variables que están graficando. Comentar lo que ven en las figuras siempre, revisen ortografía! faltan muchos tildes...}

Siguiendo con el análisis de las personas encuestadas, averiguamos la distribución de edades y el sexo de las personas fisicas. También analizamos el nivel de educacion de los encuestados y nos encontramos con una población muy bien distribuida en los 3 grupos: básico, básico superior y terciario, ya que la diferencia entre éstos era muy pequeña, lo que nos lleva a pensar que no hay una relación entre la tenencia de tierra y el nivel de educación.

\textcolor{violet}{Recodificaron la variale nivel educativo? pongan en esos tres niveles como los agruparon ustedes. }

```{r fig.cap="Notamos que los propietarios son mayormente hombres de entre 40 y 60 años, e incluso tambien de 60 a 80, lo cual demuestra como la tierra está mayormente en propiedad de personas adultas y adultos mayores."}
datos %>% filter(a9!=0,a10!=0,a10>0) %>% 
  ggplot(aes(x=cut(a11, breaks = 5,labes=FALSE),fill=factor(a10)))+geom_bar()+                  
  labs(x='Rango de edades',y='Cantidad')+
  scale_x_discrete(name="Rango de edad",
                   labels = c('Menor a 20','Entre 20 y 40',
                              'Entre 41 y 60','Entre 61 y 80',
                              'Mayor a 81'))+
  scale_fill_brewer(name="Sexo",palette="Dark2",labels=c('1'='M',
                                         '2'='F'))+ theme_bw()
```


Continuando con la variable de educación,(la reagrupamos en 3 niveles basico, basico superior y tecnico universitario) investigamos como es la relación entre ésta y la posibilidad de que haya realizado actividades de innovacion en el período. También analizamos si varía la posibilidad de contratar personal profesional para las innovaciones según la cantidad de innovaciones realizadas.

```{r}
aiv_nueva <- datos %>% 
  mutate(aiv_1 = ifelse(aiv_1 == "2", 0, aiv_1)) %>% 
  mutate(aiv_2 = ifelse(aiv_2 == "2", 0, aiv_2)) %>% 
  mutate(aiv_3 = ifelse(aiv_3 == "2", 0, aiv_3)) %>% 
  mutate(aiv_4 = ifelse(aiv_4 == "2", 0, aiv_4)) %>% 
  mutate(aiv_5 = ifelse(aiv_5 == "2", 0, aiv_5)) %>% 
  mutate(aiv_6 = ifelse(aiv_6 == "2", 0, aiv_6)) %>% 
  mutate(aiv_7 = ifelse(aiv_7 == "2", 0, aiv_7)) %>% 
  mutate(aiv_8 = ifelse(aiv_8 == "2", 0, aiv_8))

aiv_nueva = rowSums(aiv_nueva[ ,
                          c("aiv_1","aiv_2","aiv_3","aiv_4","aiv_5","aiv_6","aiv_7","aiv_8")])

datos<-cbind(datos,aiv_nueva)



```

```{r, fig.cap="Observamos una gran correlación entre estas variables, lo cual quiere decir que es más problable que una persona con mayor grado de estudios innove más en su producción que alguien con un menor grado", eval=FALSE} 
datos %>% 
  group_by(a9,aiv_nueva,a12) %>% 
  mutate(a12 = case_when(a12 %in% c(0,1,2)  ~ "Básico",
                         a12 %in% c(3,4) ~ "Básico superior",
                           a12 %in% c(5,6) ~ "Técnico univeritario")) %>% 
  filter(a12!="Otros") %>% 
  mutate(aiv_nueva = case_when(aiv_nueva %in% c(0)  ~ "0 nin",
                               aiv_nueva %in% c(1,2)  ~ "1 o 2",
                         aiv_nueva %in% c(3,4,5) ~ "3 a 5",
                           aiv_nueva %in% c(6,7,8) ~ "6 a 8")) %>% 
  filter(a9=="1",a12!="0") %>% 
  summarise(n=n() ) %>%
  mutate(freq=n/sum(n)) %>%
  ggplot(aes(x=factor(aiv_nueva),y=freq,fill=a12))+
  geom_bar(stat="identity")+
  labs(x="Innovación",y="Frecuencia")+
  scale_fill_brewer(name="Nivel educativo",palette = "Set2")

```


```{r eval=FALSE}
datos %>% 
  group_by(a9,aiv_nueva,prof_1) %>%
  mutate(aiv_nueva = case_when(aiv_nueva %in% c(0)  ~ "0 nin",
                               aiv_nueva %in% c(1,2)  ~ "1 o 2",
                               aiv_nueva %in% c(3,4,5) ~ "3 a 5",
                               aiv_nueva %in% c(6,7,8) ~ "6 a 8")) %>% 
  filter(a9=="1",prof_1!="0") %>% 
  summarise(n=n()) %>%
  mutate(freq=n/sum(n)) %>%
  ggplot(aes(x=factor(aiv_nueva),y=freq,fill=factor(prof_1)))+
  geom_bar(stat="identity",position = "dodge")+
  labs(x="Innovación",y="Frecuencia")+
  scale_fill_brewer(name="Personal profesional",palette = "Accent",labels = c(
                                                       '1' = 'Si',
                                                       '2' = 'No'))
```



```{r}
datos %>% 
  mutate(b3_7 = case_when(b3_7 %in% c(1:200)  ~ "0-200",
                               b3_7 %in% c(201:400)  ~ "200-400",
                         b3_7 %in% c(401:600)  ~ "400-600",
                          b3_7 > 600 ~ "600")) %>%
  ggplot() +
geom_mosaic(aes(x = product(b3_7, est), fill= b3_7))
```




En ésta parte vamos a comparar, con dos diagrama de barras, el porcentaje el cual segun su Condicion Juridica si contratan tanto sea personal Profesional y/o personal zafral. Para lograr esto, calculamos la cantidad, agrupando por su Condición Jurídica, de que contratan personal zafral y lo dividimos sobre la cantidad de encuestados y multiplicamos por 100, para ver su porcentaje. Usamos el mismo método para el personal profesional contratado por los encuestados. 

```{r,fig.cap="Vemos claramente que los encuestados acostumbran a contratar mayor personal profesional que personal zafral. A pesar de esto, no hay diferencias de proporción segun su Condición Jurídica."}
Cant_CJ<- datos %>% group_by(a9) %>% summarise(Cant=n())

Cant_Z<-datos %>% filter(pz_1==1,pz_2>0,pz_3>0) %>% group_by(a9) %>% summarise(Cant_z=n())

Cant_PP<- datos %>% filter(prof_1==1,prof1==1|prof2==1|prof3==1|prof4==1|prof5==1|prof6==1|prof7==1|prof8==1) %>%
  group_by(a9) %>% 
  summarise(Cant_pp=n())

tabla_porcentaje<- inner_join(inner_join(Cant_CJ, Cant_Z, by = "a9"),Cant_PP,by="a9") %>%
  mutate(Porc_PP=Cant_pp/Cant) %>%
  mutate(Porc_Z=Cant_z/Cant)

ggplot(tabla_porcentaje)+
  geom_col(aes(y=Porc_PP*100,x=a9,fill=factor(a9)))+
  geom_text(aes(x=a9,y=Porc_PP*100,label=round(Porc_PP*100)),vjust=2)+
  theme(legend.position = 'none')+
  scale_y_continuous()+
  labs(y='Porcentaje Personal Profesional')+
  scale_y_continuous(breaks = c(20,40,60,80))+
ggplot(tabla_porcentaje)+
  geom_col(aes(x=a9,y=Porc_Z*100,fill=factor(a9)))+
  geom_text(aes(x=a9,y=Porc_Z*100,label=round(Porc_Z*100)),vjust=2)+
  theme(legend.position = 'none')+
  scale_y_continuous()+
  labs(y='Porcentaje Personal zafral')+
  scale_y_continuous(breaks = c(20,40,60,80))  
```

Por otra parte, nos interesó averiguar si podiamos encontrar alguna diferencia sobre la renumeración por jornal que perciben los contratados para zafra, agrupando por la Condición Jurídica.
```{r,fig.cap="Observamos que no hay mucha diferencia entre sus cuartiles y mediana en las 3 primeras condiciones, pero si lo hay en la Condición Jurídica otra la cual tiene sueldo por jornal algunos muy bajos, datos atipicos."}
datos %>% filter(pz_1==1,pz_2>0,pz_3>0) %>% group_by(a9,a12) %>%
  ggplot()+geom_boxplot(aes(y=pz_3/pz_2,fill=factor(a9)))+
  scale_y_log10()+facet_grid(~a9)+scale_x_discrete(name='Condicion Juridica')+labs(y="Renumeración/Jornal")
```
Centrandonos en el sueldo por jornal, intentamos observar donde se agrupan mayoritariamente el sueldo por jornal con un boxplot.
```{r, fig.cap="Vemos que el sueldo por jornal de las personas zafrales se comprende entre menos de 1000$, y varios outliers."}
datos %>% filter(pz_1==1,b3_7>100,pz_2!=0,pz_3!=0) %>% summarise('Sueldo_por_jornal'=pz_3/pz_2) %>% ggplot()+geom_boxplot(aes(y=Sueldo_por_jornal))
```

Filtrando por quienes contratan persona zafral, queriamos ver si hay alguna relación entre los jornales y su respectiva renumeración.
```{r,fig.cap="Observamos clara relacion lineal fuerte negativa entre los jornales y su respectiva renumeración. Cuanto más jornales realicen, mayor será su renumeración."}
gf<-datos %>%
  filter(pz_1==1,b3_7>100,pz_2>0,pz_3>0) %>% 
  ggplot(aes(y=pz_2,x=pz_3))+geom_point()+
  geom_smooth(formula= y ~ x,method ='lm',color='red',fill='yellow')+
  scale_y_log10()+scale_x_log10()
ggplotly(gf)
```

\textcolor{violet}{En cada gráfico deben poner el nombre del mismo y variables que presentan. El comentario puede también ser extendido en el texto y usar referencias cruzadas. Hay varios sin comentar supongo que están trabajando en ellos, mañana vemos si hay alguna otra variable interesante para incluir en el análisis. No tienen nada sobre la aplicación tienen que ponerse a trabajar en la app}


```{r}
data <- datos %>%
  select("dpto","est")

sp_depto <- readOGR(here("Datos","ine_depto.shp"))
sp_depto <- ggplot2::fortify(sp_depto)
sp_depto <- transform(sp_depto,id=as.numeric(id))

datos <- right_join(sp_depto, data, by = c("id"="dpto"))

dframe_depto <- ggplot2::fortify(datos)

dframe_depto <- dframe_depto%>%
  select("id","est","long","lat")

dframe_depto%>%
filter(id!=15) %>%
ggplot(aes(x = long, y = lat)) +
geom_polygon()

```

