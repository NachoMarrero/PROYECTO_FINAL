---
title: "Proyecto"
author: ''
date: '2022-06-14'
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.pos = 'hbpt', out.extra = '', message = FALSE, warning = FALSE)
```

```{r}
library(ggmosaic)
library(tidyverse)
library(here)
library(readxl)
library(xtable)
library(maptools)
library(rgdal)
library(patchwork)
library(plotly)
datos <- read_xlsx(here("Datos","Datos_base_ganadera.xlsx"))
```


## Introducción

Este proyecto nace como un instrumento para poder aplicar los contenidos aprendidos durante el semestre en un problema real. Se tendrá que demostrar los conocimentos adquiridos al realizar un análisis exploratorio sobre datos de interés nacional, poniendo especial énfasis en la correcta visualización de los resultados obtenidos, realizando una correcta interpretación de la misma. 

En el caso de este grupo en cuestión, se analizarán datos de una encuesta agropecuaria, que fueron elegidos para llevar a cabo estos objetivos, relacionando las características de la persona fisíca y su territorio con su productividad y tecnología, entre otras variables. Se utilizará exclusivamente el lenguaje de programación R, y sus respectivas expansiones, como RMarkdown, Shiny y RStudio.

\textcolor{violet}{Debe quedar más claro que son los datos,tienen un reporte sobre la encuensta que les puede ayudar para escribir cuál es el objetivo e dicha encuesta y referenciarla, veo que escriben más abajo esto pero en la introduccion deben porner algo más que es una encuesta gropecuaria. Los paquetes y R se deben citar. 
Les puse el doc que compile a pdf, echo=FALSE para que no salga el código en el doc por defecto y les arreglé la tabla}

## Datos

Ésta encuesta fue realizada por el Ministerio de Ganadería, Agricultura y Pesca del Uruguay.

Trata de un muestreo cuya base muestral fue el censo general agropecuario del 2011 que tenía 25.566 explotaciones ganaderas, todas las variables son de tipo **double** ya que eran preguntas multiple opción (en su mayoría) con una recodificación numérica. Luego se realizó un muestreo por estrato de tamaño y por un criterio geográfico. El tamaño de la muestra resultó ser de 1.506 casos (cada observación corresponde a un encuestado) de los cuales algunos fueron descartados(porque ya no eran ganaderos o por otros aspectos) por lo que la muestra final es de 1.426 .

En este trabajo se propone una descripción de los resultados de la encuesta sin expandir a través de ponderadores por lo que los resultados a los que arribemos solo serán validos para estos casos y no serán conclusiones que se puedan extender al conjunto de los productores ganaderos.

```{r, results='asis'}
options(xtable.comment = FALSE)

datos_1 <- data.frame(Variable = c("edad","a9","a12","aiv_nueva",
                                   "a16_i","dpto","b3_i","b3_7","est"),
                      Descripcion = c("Edad","Condicion Juridica","Nivel de Educacion","Cantidad Innovaciones realizadas en 8 posibles ramas distintas","Tipo de energia utilizada","Departamento donde se ubica la propiedad","Tenencia de Tierras","Total del territorio en ha","Unidades ganaderas en el territorio (1-8)"))


datos_1 %>% xtable(caption="Descripción de las Variables") %>% print(include.rownames = FALSE)
```


 Para realizar la exploración, nos planteamos algunas preguntas para orientar el análisis. En primer lugar, decidimos investigar la condicion Jurídica de los propietarios encuestados.
 
```{r, fig.cap= "Podemos observar como la mayor cantidad de encuestados son personas fisicas"}
datos %>% 
  group_by(a9) %>% 
  ggplot(aes(x=fct_infreq(factor(a9))))+
  geom_bar()+
  labs(y="Cantidad")+
  scale_x_discrete(name="Condición jurídica",labels = c(
                                                       '1' = 'Persona física',
                                                       '2' = 'Sociedad sin contrato',
                                                       '3' = 'Sociedad con contrato legal',
                                                       '4' = 'Otra'))
```

\textcolor{violet}{Deben incluir referencias cruzadas y en la figura debe aparecer el nombre del gráfico y la variable o variables que están graficando. Comentar lo que ven en las figuras siempre, revisen ortografía! faltan muchos tildes...}

Siguiendo con el análisis de las personas encuestadas, averiguamos la distribución de edades y el sexo de las personas fisicas. También analizamos el nivel de educacion de los encuestados y nos encontramos con una población muy bien distribuida en los 3 grupos: básico, básico superior y terciario, ya que la diferencia entre éstos era muy pequeña, lo que nos lleva a pensar que no hay una relación entre la tenencia de tierra y el nivel de educación.

\textcolor{violet}{Recodificaron la variale nivel educativo? pongan en esos tres niveles como los agruparon ustedes. }

```{r fig.cap="Notamos que los propietarios son mayormente hombres de entre 40 y 60 años, e incluso tambien de 60 a 80, lo cual demuestra como la tierra está mayormente en propiedad de personas adultas y adultos mayores."}
datos %>% filter(a9!=0,a10!=0,a10>0) %>% 
  ggplot(aes(x=cut(a11, breaks = 5,labes=FALSE),fill=factor(a10)))+geom_bar()+                  
  labs(x='Rango de edades',y='Cantidad')+
  scale_x_discrete(name="Rango de edad",
                   labels = c('Menor a 20','Entre 20 y 40',
                              'Entre 41 y 60','Entre 61 y 80',
                              'Mayor a 81'))+
  scale_fill_brewer(name="Sexo",palette="Dark2",labels=c('1'='M',
                                         '2'='F'))
```


Continuando con la variable de educación, investigamos como es la relación entre ésta y la posibilidad de que haya realizado actividades de innovacion en el período. También analizamos si varía la posibilidad de contratar personal profesional para las innovaciones según la cantidad de innovaciones realizadas.

```{r, eval=FALSE}
aiv_nueva <- datos %>% 
  mutate(aiv_1 = ifelse(aiv_1 == "2", 0, aiv_1)) %>% 
  mutate(aiv_2 = ifelse(aiv_2 == "2", 0, aiv_2)) %>% 
  mutate(aiv_3 = ifelse(aiv_3 == "2", 0, aiv_3)) %>% 
  mutate(aiv_4 = ifelse(aiv_4 == "2", 0, aiv_4)) %>% 
  mutate(aiv_5 = ifelse(aiv_5 == "2", 0, aiv_5)) %>% 
  mutate(aiv_6 = ifelse(aiv_6 == "2", 0, aiv_6)) %>% 
  mutate(aiv_7 = ifelse(aiv_7 == "2", 0, aiv_7)) %>% 
  mutate(aiv_8 = ifelse(aiv_8 == "2", 0, aiv_8))

aiv_nueva = rowSums(aiv_nueva[ ,
                          c("aiv_1","aiv_2","aiv_3","aiv_4","aiv_5","aiv_6","aiv_7","aiv_8")])

datos<-cbind(datos,aiv_nueva)

aio_nueva <- datos %>% 
  mutate(aio_1 = ifelse(aio_1 == "2", 0, aio_1)) %>% 
  mutate(aio_2 = ifelse(aio_2 == "2", 0, aio_2)) %>% 
  mutate(aio_3 = ifelse(aio_3 == "2", 0, aio_3)) %>% 
  mutate(aio_4 = ifelse(aio_4 == "2", 0, aio_4)) %>% 
  mutate(aio_5 = ifelse(aio_5 == "2", 0, aio_5)) %>% 
  mutate(aio_6 = ifelse(aio_6 == "2", 0, aio_6)) %>% 
  mutate(aio_7 = ifelse(aio_7 == "2", 0, aio_7)) %>% 
  mutate(aio_8 = ifelse(aio_8 == "2", 0, aio_8))

aio_nueva = rowSums(aio_nueva[ ,
                          c("aio_1","aio_2","aio_3","aio_4","aio_5","aio_6","aio_7","aio_8")])

```

```{r, fig.cap="Observamos una gran correlación entre estas variables, lo cual quiere decir que es más problable que una persona con mayor grado de estudios innove más en su producción que alguien con un menor grado", eval=FALSE} 
datos %>% 
  group_by(a9,aiv_nueva,a12) %>% 
  mutate(a12 = case_when(a12 %in% c(0,1,2)  ~ "Básico",
                         a12 %in% c(3,4) ~ "Básico superior",
                           a12 %in% c(5,6) ~ "Técnico univeritario")) %>% 
  filter(a12!="Otros") %>% 
  mutate(aiv_nueva = case_when(aiv_nueva %in% c(0)  ~ "0 nin",
                               aiv_nueva %in% c(1,2)  ~ "1 o 2",
                         aiv_nueva %in% c(3,4,5) ~ "3 a 5",
                           aiv_nueva %in% c(6,7,8) ~ "6 a 8")) %>% 
  filter(a9=="1",a12!="0") %>% 
  summarise(n=n() ) %>%
  mutate(freq=n/sum(n)) %>%
  ggplot(aes(x=factor(aiv_nueva),y=freq,fill=a12))+
  geom_bar(stat="identity")+
  labs(x="Innovación",y="Frecuencia")+
  scale_fill_brewer(name="Nivel educativo",palette = "Set2")

```

```{r, eval=FALSE}
datos %>% 
  group_by(a9,aio_nueva,a12) %>% 
  mutate(a12 = case_when(a12 %in% c(0,1,2)  ~ "Básico",
                         a12 %in% c(3,4) ~ "Básico superior",
                           a12 %in% c(5,6) ~ "Técnico univeritario")) %>% 
  filter(a12!="Otros") %>% 
  mutate(aio_nueva = case_when(aio_nueva %in% c(0)  ~ "0 nin",
                               aio_nueva %in% c(1,2)  ~ "1 o 2",
                         aio_nueva %in% c(3,4,5) ~ "3 a 5",
                           aio_nueva %in% c(6,7,8) ~ "6 a 8")) %>% 
  filter(a9=="1",a12!="0") %>% 
  summarise(n=n() ) %>%
  mutate(freq=n/sum(n)) %>%
  ggplot(aes(x=factor(aio_nueva),y=freq,fill=a12))+
  geom_bar(stat="identity")+
  labs(x="Innovación",y="Frecuencia")+
  scale_fill_brewer(name="Nivel educativo",palette = "Set3")
```

```{r eval=FALSE}
datos %>% 
  group_by(a9,aiv_nueva,prof_1) %>%
  mutate(aiv_nueva = case_when(aiv_nueva %in% c(0)  ~ "0 nin",
                               aiv_nueva %in% c(1,2)  ~ "1 o 2",
                               aiv_nueva %in% c(3,4,5) ~ "3 a 5",
                               aiv_nueva %in% c(6,7,8) ~ "6 a 8")) %>% 
  filter(a9=="1",prof_1!="0") %>% 
  summarise(n=n()) %>%
  mutate(freq=n/sum(n)) %>%
  ggplot(aes(x=factor(aiv_nueva),y=freq,fill=factor(prof_1)))+
  geom_bar(stat="identity",position = "dodge")+
  labs(x="Innovación",y="Frecuencia")+
  scale_fill_brewer(name="Personal profesional",palette = "Accent",labels = c(
                                                       '1' = 'Si',
                                                       '2' = 'No'))
```



```{r}
datos %>% 
  mutate(b3_7 = case_when(b3_7 %in% c(1:200)  ~ "0-200",
                               b3_7 %in% c(201:400)  ~ "200-400",
                         b3_7 %in% c(401:600)  ~ "400-600",
                          b3_7 > 600 ~ "600")) %>%
  ggplot() +
geom_mosaic(aes(x = product(b3_7, est), fill= b3_7))
```


















```{r}
data.frame(datos %>%
             select(a16_1,a16_2,a16_3,a16_4,a16_5) %>%
             filter(a16_1==1|a16_2==1|a16_3==1|a16_4==1|a16_5==1)) %>% 
             mutate('Energia_electrica'=case_when(a16_1==1~"UTE", 
                                     a16_2==1~ "Grupo electrógeno",
                                     a16_3==1~"Eólica",
                                     a16_4==1~"Otro",
                                     a16_5==1~ 'No tiene')) %>% select(Energia_electrica) %>%
            group_by(Energia_electrica) %>% summarise(n=n()) %>% 
            ggplot(aes(x=Energia_electrica,y=n,fill=Energia_electrica))+geom_col()+
  labs(x="Tipo de energia electrica",y='Cantidad')
```

```{r}
data.frame(datos %>%
             select(a9,a16_1,a16_2,a16_3,a16_4,a16_5) %>%
             filter(a16_1==1|a16_2==1|a16_3==1|a16_4==1|a16_5==1)) %>% 
  mutate('Energia_electrica'=case_when(a16_1==1~"UTE", 
                                       a16_2==1~ "Grupo electrogeno",
                                       a16_3==1~"Eolica",
                                       a16_4==1~"Otro",
                                       a16_5==1~ 'No tiene')) %>%
  group_by(Energia_electrica) %>%
  ggplot()+geom_mosaic(aes(x=product(Energia_electrica,a9),fill=Energia_electrica))+
  labs(x='Condicion jurídica',y='Tipo de Energía')+
  scale_fill_brewer(name="Tipo de Energia",palette="Dark2")

```

```{r, eval=FALSE}
datos %>% 
  group_by(a9,aiv_nueva) %>% 
  mutate(a12 = case_when(a12 %in% c(0,1,2)  ~ "Básico",
                         a12 %in% c(3,4) ~ "Basico superior",
                           a12 %in% c(5,6) ~ "Tecnico univeritario")) %>%
  filter(a9=="1",a12!="0") %>% 
  ggplot(aes(x=factor(a12)))+
  geom_bar()+
  labs(y="Cantidad",x="Nivel educativo")
```

En ésta parte vamos a comparar, con dos diagrama de barras,la frecuencia de, según su Condición Jurídica, si contratan personal profesional y/o personal zafral.
```{r}
Cant_CJ<- datos %>% group_by(a9) %>% summarise(Cant=n())
Cant_Z<-datos %>% filter(pz_1==1,pz_2>0,pz_3>0) %>% group_by(a9) %>% summarise(Cant_z=n())
Cant_PP<- datos %>% filter(prof_1==1,prof1==1|prof2==1|prof3==1|prof4==1|prof5==1|prof6==1|prof7==1|prof8==1) %>%
  group_by(a9) %>% summarise(Cant_pp=n())
tabla_porcentaje<- inner_join(inner_join(Cant_CJ, Cant_Z, by = "a9"),Cant_PP,by="a9") %>%
  mutate(Porc_PP=Cant_pp/Cant) %>% mutate(Porc_Z=Cant_z/Cant)
ggplot(tabla_porcentaje)+geom_col(aes(y=Porc_PP*100,x=a9,fill=factor(a9)))+
  geom_text(aes(x=a9,y=Porc_PP*100,label=round(Porc_PP*100)),vjust=2)+
  theme(legend.position = 'none')+scale_y_continuous()+
  labs(y='Porcentaje Personal Profesional')+scale_y_continuous(breaks = c(20,40,60,80))+
ggplot(tabla_porcentaje)+geom_col(aes(x=a9,y=Porc_Z*100,fill=factor(a9)))+
  geom_text(aes(x=a9,y=Porc_Z*100,label=round(Porc_Z*100)),vjust=2)+
  theme(legend.position = 'none')+scale_y_continuous()+
  labs(y='Porcentaje Personal zafral')+scale_y_continuous(breaks = c(20,40,60,80))
```

Por otra parte, nos interesó saber el sueldo por jornada de las personas zafral, separando por Condición Jurídica y tratar de ver si los datos nos dan indicio de si dependiendo de su condición se acostumbra a pagar en mayor o menor proporción.
```{r}
datos %>% filter(pz_1==1,pz_2>0,pz_3>0) %>% group_by(a9,a12) %>%
  ggplot()+geom_boxplot(aes(y=pz_3/pz_2,fill=factor(a9)))+
  scale_y_log10()+facet_grid(~a9)+scale_x_discrete(name='Condicion Juridica')+labs(y="Renumeración/Jornal")
```

Filtrando por quienes contratan persona zafral, queriamos ver si hay alguna relación entre los jornales y su respectiva renumeración.
```{r}
gf<-datos %>% filter(pz_1==1,b3_7>100,pz_2>0,pz_3>0) %>% 
  ggplot(aes(y=pz_2,x=pz_3))+geom_point()+ geom_smooth(method ='lm',color='red',fill='yellow')+
  scale_y_log10()+scale_x_log10()
ggplotly(gf)
```

Centrandonos en el sueldo por jornal, intentamos observar donde se agrupan mayoritariamente el sueldo por jornal con un boxplot.
```{r}
datos %>% filter(pz_1==1,b3_7>100,pz_2!=0,pz_3!=0) %>% summarise('Sueldo_por_jornal'=pz_3/pz_2) %>% ggplot()+geom_boxplot(aes(y=Sueldo_por_jornal))
```


\textcolor{violet}{En cada gráfico deben poner el nombre del mismo y variables que presentan. El comentario puede también ser extendido en el texto y usar referencias cruzadas. Hay varios sin comentar supongo que están trabajando en ellos, mañana vemos si hay alguna otra variable interesante para incluir en el análisis. No tienen nada sobre la aplicación tienen que ponerse a trabajar en la app}
